<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENLAB - DNA zu Peptid</title>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #2980b9;
            --bg: #ecf0f1;
            --header-bg: #fff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            height: 100vh; 
            background: var(--bg); 
            color: var(--primary);
            overflow: hidden; 
        }

        /* Loader */
        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: white; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; color: #7f8c8d;
        }

        /* HEADER */
        header {
            background: var(--header-bg);
            padding: 15px 20px;
            border-bottom: 3px solid var(--accent);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0;
            text-align: center;
        }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); }
        h4 { margin: 5px 0 0 0; font-size: 0.9rem; color: #7f8c8d; font-weight: normal; font-style: italic; }

        /* LAYOUT */
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 20px;
            gap: 20px;
        }

        /* SIDEBAR (Desktop) */
        #sidebar { 
            width: 260px; 
            background: #fff; 
            border-radius: 8px;
            overflow-y: auto; 
            padding: 15px;
            flex-shrink: 0;
            display: none; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        @media (min-width: 900px) { #sidebar { display: block; } }

        .aa-card { 
            border: 1px solid #eee; 
            padding: 8px; 
            margin-bottom: 8px; 
            border-radius: 6px; 
            background: #fdfdfd; 
            font-size: 0.85rem;
            transition: 0.2s;
        }
        .aa-card:hover { border-color: var(--accent); transform: translateX(3px); }
        .aa-header { font-weight: bold; display: flex; justify-content: space-between; color: var(--accent); }

        /* MAIN */
        #main { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            overflow-y: auto;
        }

        .card { 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }

        /* INPUT */
        .dna-input { 
            width: 100%; 
            font-family: 'Courier New', monospace; 
            font-size: 1.4rem; 
            padding: 10px; 
            border: 2px solid #bdc3c7; 
            border-radius: 4px; 
            text-transform: uppercase; 
            color: var(--primary);
            box-sizing: border-box; 
        }
        .dna-input:focus { border-color: var(--accent); outline: none; }
        
        /* CHEMIE FENSTER */
        .chem-window {
            width: 100%;
            height: 500px; 
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            overflow-x: auto; 
            overflow-y: hidden; 
            background: #ffffff;
            position: relative;
            margin-bottom: 15px;
            display: flex;       
            align-items: center; /* Vertikal zentrieren */
        }
        
        #chemCanvas { display: block; background-color: #ffffff; }

        /* DATEN OUTPUT */
        .data-row { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 8px; 
            font-family: monospace; font-size: 0.9rem; 
        }
        .label { font-weight: bold; min-width: 80px; color: #7f8c8d; }
        .value { 
            background: #f0f2f5; padding: 4px 8px; border-radius: 4px; 
            color: #2c3e50; white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; flex-grow: 1;
        }

        /* BUTTONS */
        .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        button, .btn-link { 
            padding: 8px 16px; border: none; border-radius: 5px; 
            cursor: pointer; font-size: 0.9rem; display: inline-flex; 
            align-items: center; gap: 5px; color: white; background: var(--accent);
            text-decoration: none; transition: 0.2s;
        }
        button:hover, .btn-link:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-opt { background: #e67e22; }
        .btn-colab { background: #27ae60; }

    </style>
</head>
<body>

    <div id="loader">Lade GenLab...</div>

    <header>
        <h1>GENLAB - vom genetischen Code zum Peptid</h1>
        <h4>Erstellt von Mag. Erich Kerzendorfer mit Hilfe von Gemini PRO</h4>
    </header>

    <div class="container">
        <div id="sidebar">
            <h3 style="margin-top:0; color:#34495e">AminosÃ¤uren</h3>
            <div id="aa-list"></div>
        </div>

        <div id="main">
            
            <div class="card">
                <h3 style="margin-top:0">1. Eingabe (DNA)</h3>
                <input type="text" id="dnaInput" class="dna-input" placeholder="GCT AAA ..." autocomplete="off">
                <div id="statusMsg" style="color:#c0392b; margin-top:5px; height:1.2em; font-size:0.9rem;"></div>
            </div>

            <div class="card" style="flex-grow:1; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h3 style="margin:0">2. Struktur & Daten</h3>
                    <button class="btn-opt" id="btnOptimize" title="Zeichnung vergrÃ¶ÃŸern und entwirren">
                        ðŸª„ Optimieren & Zoom
                    </button>
                </div>

                <div class="chem-window" id="chemWindow">
                    <canvas id="chemCanvas"></canvas>
                </div>

                <div class="data-row"><span class="label">3-Letter:</span> <span id="out3" class="value">-</span></div>
                <div class="data-row"><span class="label">FASTA:</span> <span id="out1" class="value">-</span></div>
                <div class="data-row"><span class="label">SMILES:</span> <span id="outSmiles" class="value" style="font-size:0.8rem">-</span></div>

                <div class="btn-group">
                    <button id="btnCopyFasta">ðŸ“„ FASTA</button>
                    <button id="btnCopySmiles">ðŸ§ª SMILES</button>
                    <button id="btnCopyImg" title="Kopiert Bild mit weiÃŸem Hintergrund">ðŸ“· Bild</button>
                    <div style="flex-grow:1"></div>
                    <a href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/main/AlphaFold2.ipynb" target="_blank" class="btn-link btn-colab">
                        ðŸš€ ColabFold â†—
                    </a>
                </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // Loader weg
    const loader = document.getElementById('loader');
    if(loader) loader.style.display = 'none';

    // --- DATEN ---
    const aaData = {
        'A': {n:'Alanin', c:['GCT','GCC','GCA','GCG'], s:'C'},
        'R': {n:'Arginin', c:['CGT','CGC','CGA','CGG','AGA','AGG'], s:'CCCNC(=N)N'},
        'N': {n:'Asparagin', c:['AAT','AAC'], s:'CC(=O)N'},
        'D': {n:'AsparaginsÃ¤ure', c:['GAT','GAC'], s:'CC(=O)O'},
        'C': {n:'Cystein', c:['TGT','TGC'], s:'CS'},
        'Q': {n:'Glutamin', c:['CAA','CAG'], s:'CCC(=O)N'},
        'E': {n:'GlutaminsÃ¤ure', c:['GAA','GAG'], s:'CCC(=O)O'},
        'G': {n:'Glycin', c:['GGT','GGC','GGA','GGG'], s:''},
        'H': {n:'Histidin', c:['CAT','CAC'], s:'CC1=CN=CN1'},
        'I': {n:'Isoleucin', c:['ATT','ATC','ATA'], s:'C(C)CC'},
        'L': {n:'Leucin', c:['TTA','TTG','CTT','CTC','CTA','CTG'], s:'CC(C)C'},
        'K': {n:'Lysin', c:['AAA','AAG'], s:'CCCCN'},
        'M': {n:'Methionin', c:['ATG'], s:'CCSC'},
        'F': {n:'Phenylalanin', c:['TTT','TTC'], s:'CC1=CC=CC=C1'},
        'P': {n:'Prolin', c:['CCT','CCC','CCA','CCG'], s:'special'},
        'S': {n:'Serin', c:['TCT','TCC','TCA','TCG','AGT','AGC'], s:'CO'},
        'T': {n:'Threonin', c:['ACT','ACC','ACA','ACG'], s:'C(O)C'},
        'W': {n:'Tryptophan', c:['TGG'], s:'CC1=CNC2=CC=CC=C12'},
        'Y': {n:'Tyrosin', c:['TAT','TAC'], s:'CC1=CC=C(O)C=C1'},
        'V': {n:'Valin', c:['GTT','GTC','GTA','GTG'], s:'C(C)C'},
        'STOP': {n:'STOP', c:['TAA','TAG','TGA'], s:null}
    };

    const codonTable = {};
    for (let k in aaData) { aaData[k].c.forEach(cod => codonTable[cod] = k); }

    let currentSmiles = "";
    let currentCount = 0;

    // --- SETUP SIDEBAR ---
    const sb = document.getElementById('aa-list');
    Object.keys(aaData).sort().forEach(k => {
        if(k==='STOP') return;
        sb.innerHTML += `
            <div class="aa-card">
                <div class="aa-header"><span>${aaData[k].n}</span><span>${k}</span></div>
                <div style="color:#666">${aaData[k].c.join(', ')}</div>
            </div>`;
    });

    // --- EVENT LISTENERS ---
    const dnaInput = document.getElementById('dnaInput');
    
    dnaInput.addEventListener('input', (e) => {
        let raw = e.target.value.toUpperCase().replace(/[^ACGT]/g, '');
        let fmt = raw.replace(/(.{3})/g, '$1 ').trim();
        if(dnaInput.value !== fmt) dnaInput.value = fmt;
        processDNA(raw);
    });

    document.getElementById('btnOptimize').addEventListener('click', () => {
        if(currentSmiles) draw(currentSmiles, currentCount, true);
    });

    document.getElementById('btnCopyFasta').addEventListener('click', () => copyToClip('out1'));
    document.getElementById('btnCopySmiles').addEventListener('click', () => copyToClip('outSmiles'));
    document.getElementById('btnCopyImg').addEventListener('click', copyImg);

    // --- LOGIC ---
    function processDNA(raw) {
        const triplets = raw.match(/.{1,3}/g) || [];
        let seq = [];
        let seq3 = [];
        let error = "";

        for(let t of triplets) {
            if(t.length < 3) continue;
            let aa = codonTable[t];
            if(!aa) { error = "Unbekannt: " + t; continue; }
            if(aa === 'STOP') break;
            seq.push(aa);
            seq3.push(aaData[aa].n.substring(0,3));
        }

        document.getElementById('statusMsg').innerText = error;
        document.getElementById('out3').innerText = seq3.join(' - ');
        document.getElementById('out1').innerText = seq.join('');
        
        if(seq.length > 0) {
            currentSmiles = buildSmiles(seq);
            currentCount = seq.length;
            document.getElementById('outSmiles').innerText = currentSmiles;
            draw(currentSmiles, currentCount, false);
        } else {
            resetCanvas();
        }
    }

    function buildSmiles(seq) {
        let s = "";
        seq.forEach(aa => {
            if(aa === 'P') s += "N1[C@@H](CCC1)C(=O)";
            else if(aa === 'G') s += "NCC(=O)";
            else s += `N[C@@H](${aaData[aa].s})C(=O)`;
        });
        return s + "O";
    }

    // --- DRAWING ENGINE ---
    function draw(smiles, count, optimize) {
        if(typeof SmilesDrawer === 'undefined') {
            alert("Fehler: Zeichenbibliothek nicht geladen.");
            return;
        }

        const cvs = document.getElementById('chemCanvas');
        const win = document.getElementById('chemWindow');
        
        // GRÃ–SSE & ZOOM:
        // Optimize: Wir geben deutlich mehr Breite pro AS (100px) und machen alles grÃ¶ÃŸer
        let pxPerResidue = optimize ? 100 : 60;
        let w = Math.max(600, count * pxPerResidue);
        let h = 500; 

        cvs.width = w;
        cvs.height = h;

        let options = {
            width: w,
            height: h,
            // ZOOM EFFEKT: Wir erhÃ¶hen BondLength und FontSize im Optimize Modus
            bondThickness: optimize ? 1.5 : 1.0,
            bondLength: optimize ? 30 : 18,     // LÃ¤nger = "GrÃ¶ÃŸer" gezoomt
            shortBondLength: 0.85,
            fontSize: optimize ? 14 : 10,       // GrÃ¶ÃŸere Schrift
            padding: 20,
            experimentalSSSR: true,
            overlapResolutionIterations: optimize ? 15 : 1
        };

        let drawer = new SmilesDrawer.Drawer(options);
        
        SmilesDrawer.parse(smiles, function(tree) {
            drawer.draw(tree, 'chemCanvas', 'light', false);
            // Horizontal zum Anfang scrollen
            win.scrollLeft = 0; 
        }, function(err) {
            console.log(err);
        });
    }

    function resetCanvas() {
        const cvs = document.getElementById('chemCanvas');
        cvs.width = 600; cvs.height = 500;
        const ctx = cvs.getContext('2d');
        ctx.font = "16px sans-serif";
        ctx.fillStyle = "#bdc3c7";
        ctx.fillText("Bitte DNA eingeben...", 20, 250);
        document.getElementById('outSmiles').innerText = "-";
        currentSmiles = "";
    }

    function copyToClip(id) {
        let t = document.getElementById(id).innerText;
        if(t && t !== '-') navigator.clipboard.writeText(t).then(()=>alert("Kopiert!"));
    }

    function copyImg() {
        const sourceCanvas = document.getElementById('chemCanvas');
        
        // 1. TemporÃ¤ren Canvas erstellen
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = sourceCanvas.width;
        tempCanvas.height = sourceCanvas.height;
        const ctx = tempCanvas.getContext('2d');

        // 2. WeiÃŸ fÃ¼llen (Hintergrund)
        ctx.fillStyle = '#FFFFFF';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // 3. Originalbild darÃ¼ber malen
        ctx.drawImage(sourceCanvas, 0, 0);

        // 4. Kopieren
        tempCanvas.toBlob(b => {
            try { 
                navigator.clipboard.write([new ClipboardItem({"image/png":b})]); 
                alert("Bild (weiÃŸer Hintergrund) kopiert!"); 
            }
            catch(e) { alert("Browser-Sicherheit: Bitte Screenshot machen."); }
        });
    }

    // Init Reset
    resetCanvas();

});
</script>
</body>
</html>
