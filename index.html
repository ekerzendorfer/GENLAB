<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Translation Labor (Diagnose Modus)</title>
    
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: white; border-right: 1px solid #ddd; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        .aa-card { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-size: 0.9rem; }
        .aa-header { font-weight: bold; display: flex; justify-content: space-between; }
        
        /* Main */
        #main { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        
        /* Inputs */
        .box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .dna-input { width: 100%; font-family: monospace; font-size: 1.5rem; letter-spacing: 2px; padding: 10px; border: 2px solid #ddd; text-transform: uppercase; }
        
        /* Visualisierung */
        .chem-window { 
            width: 100%; 
            height: 600px; /* Quadratisches Fenster */
            overflow: auto; /* Scrollbalken wenn nÃ¶tig */
            border: 1px solid #ccc; 
            background: white; 
            position: relative;
        }
        
        #chemCanvas { display: block; } /* GrÃ¶ÃŸe wird via JS gesetzt */

        /* Protokoll Fenster fÃ¼r Fehler */
        #debugLog {
            position: fixed; top: 0; right: 0; width: 300px; height: 100px; 
            background: rgba(0,0,0,0.8); color: lime; font-family: monospace; 
            font-size: 10px; padding: 10px; overflow-y: auto; z-index: 9999;
            pointer-events: none; opacity: 0.8;
        }

        /* Hilfsklassen */
        .row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .code { font-family: monospace; background: #eee; padding: 2px 5px; }
        .btn { padding: 8px 15px; background: var(--accent); color: white; border: none; cursor: pointer; border-radius: 4px; text-decoration: none;}
        .btn:hover { opacity: 0.9; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/smiles-drawer@2.0.1/dist/smiles-drawer.min.js" 
            onload="log('Bibliothek geladen via jsDelivr')" 
            onerror="log('FEHLER: jsDelivr blockiert? Versuche unpkg...'); loadBackupLib()">
    </script>
</head>
<body>

    <div id="debugLog">System Start...<br></div>

    <div id="sidebar">
        <h3>AminosÃ¤uren</h3>
        <div id="aa-list">Lade...</div>
    </div>

    <div id="main">
        <div class="box">
            <h3>Genetischer Code</h3>
            <input type="text" id="dnaInput" class="dna-input" placeholder="ACG TCC ..." autocomplete="off">
            <div style="font-size:0.8rem; color:#666; margin-top:5px">
                Eingabe: A, C, G, T.
            </div>
        </div>

        <div class="box" style="flex-grow: 1; display: flex; flex-direction: column;">
            <h3>Proteinstruktur</h3>
            
            <div class="chem-window" id="chemWindow">
                <canvas id="chemCanvas"></canvas>
            </div>

            <div class="row"><b>3-Letter:</b> <span id="out3">-</span></div>
            <div class="row"><b>FASTA:</b> <span id="out1" class="code">-</span></div>
            <div class="row"><b>SMILES:</b> <span id="outSmiles" class="code" style="font-size:10px; max-width: 500px; overflow:hidden;">-</span></div>

            <div class="row" style="margin-top: 15px; flex-wrap: wrap;">
                <button class="btn" onclick="copyToClip('out1')">FASTA kopieren</button>
                <button class="btn" onclick="copyToClip('outSmiles')">SMILES kopieren</button>
                <button class="btn" onclick="copyImage()">ðŸ“· Bild kopieren</button>
                <div style="flex-grow:1"></div>
                <button class="btn" style="background: #95a5a6;" onclick="init()">ðŸ”„ Reset / Neustart</button>
            </div>
        </div>
    </div>

<script>
    // --- DEBUG HELPER ---
    function log(msg) {
        const d = document.getElementById('debugLog');
        if(d) d.innerHTML += msg + "<br>";
        console.log(msg);
    }

    function loadBackupLib() {
        const script = document.createElement('script');
        script.src = "https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js";
        script.onload = () => log("Bibliothek geladen via unpkg");
        script.onerror = () => log("KRITISCHER FEHLER: Alle Bibliotheken blockiert!");
        document.head.appendChild(script);
    }

    // --- DATEN ---
    const aaData = {
        'A': {n:'Ala', c:['GCT','GCC','GCA','GCG'], s:'C'},
        'R': {n:'Arg', c:['CGT','CGC','CGA','CGG','AGA','AGG'], s:'CCCNC(=N)N'},
        'N': {n:'Asn', c:['AAT','AAC'], s:'CC(=O)N'},
        'D': {n:'Asp', c:['GAT','GAC'], s:'CC(=O)O'},
        'C': {n:'Cys', c:['TGT','TGC'], s:'CS'},
        'Q': {n:'Gln', c:['CAA','CAG'], s:'CCC(=O)N'},
        'E': {n:'Glu', c:['GAA','GAG'], s:'CCC(=O)O'},
        'G': {n:'Gly', c:['GGT','GGC','GGA','GGG'], s:''},
        'H': {n:'His', c:['CAT','CAC'], s:'CC1=CN=CN1'},
        'I': {n:'Ile', c:['ATT','ATC','ATA'], s:'C(C)CC'},
        'L': {n:'Leu', c:['TTA','TTG','CTT','CTC','CTA','CTG'], s:'CC(C)C'},
        'K': {n:'Lys', c:['AAA','AAG'], s:'CCCCN'},
        'M': {n:'Met', c:['ATG'], s:'CCSC'},
        'F': {n:'Phe', c:['TTT','TTC'], s:'CC1=CC=CC=C1'},
        'P': {n:'Pro', c:['CCT','CCC','CCA','CCG'], s:'special'},
        'S': {n:'Ser', c:['TCT','TCC','TCA','TCG','AGT','AGC'], s:'CO'},
        'T': {n:'Thr', c:['ACT','ACC','ACA','ACG'], s:'C(O)C'},
        'W': {n:'Trp', c:['TGG'], s:'CC1=CNC2=CC=CC=C12'},
        'Y': {n:'Tyr', c:['TAT','TAC'], s:'CC1=CC=C(O)C=C1'},
        'V': {n:'Val', c:['GTT','GTC','GTA','GTG'], s:'C(C)C'},
        'STOP': {n:'STOP', c:['TAA','TAG','TGA'], s:null}
    };

    const codonTable = {};
    for (let k in aaData) { aaData[k].c.forEach(cod => codonTable[cod] = k); }

    // --- MAIN LOGIK ---
    let drawer = null;

    function init() {
        log("Initialisiere...");
        
        // Sidebar fÃ¼llen
        const sb = document.getElementById('aa-list');
        sb.innerHTML = "";
        Object.keys(aaData).sort().forEach(k => {
            if(k === 'STOP') return;
            sb.innerHTML += `<div class="aa-card"><div class="aa-header"><span>${aaData[k].n}</span><span>${k}</span></div><div style="font-size:0.8em; color:#666">${aaData[k].c.join(', ')}</div></div>`;
        });

        // Event Listener
        const inp = document.getElementById('dnaInput');
        inp.value = ""; // Reset
        inp.oninput = handleInput;
        
        // Initialer Canvas Reset
        const cvs = document.getElementById('chemCanvas');
        cvs.width = 800; cvs.height = 600;
        const ctx = cvs.getContext('2d');
        ctx.font = "20px sans-serif";
        ctx.fillStyle = "#ccc";
        ctx.fillText("System bereit. Bitte DNA eingeben.", 50, 300);
        log("GUI bereit.");
    }

    function handleInput(e) {
        let raw = e.target.value.toUpperCase().replace(/[^ACGT]/g, '');
        // Formatierung
        let fmt = raw.replace(/(.{3})/g, '$1 ').trim();
        if(e.target.value !== fmt) e.target.value = fmt;

        processDNA(raw);
    }

    function processDNA(raw) {
        const triplets = raw.match(/.{1,3}/g) || [];
        let seq = [];
        let seq3 = [];

        for(let t of triplets) {
            if(t.length < 3) continue;
            let aa = codonTable[t];
            if(!aa) continue; // Fehler ignorieren oder rot markieren
            if(aa === 'STOP') break;
            seq.push(aa);
            seq3.push(aaData[aa].n);
        }

        // GUI Updates
        document.getElementById('out3').innerText = seq3.join('-');
        document.getElementById('out1').innerText = seq.join('');
        
        if(seq.length > 0) {
            let smiles = buildSmiles(seq);
            document.getElementById('outSmiles').innerText = smiles;
            draw(smiles, seq.length);
        }
    }

    function buildSmiles(seq) {
        let s = "";
        seq.forEach(aa => {
            if(aa === 'P') s += "N1[C@@H](CCC1)C(=O)";
            else if(aa === 'G') s += "NCC(=O)";
            else s += `N[C@@H](${aaData[aa].s})C(=O)`;
        });
        return s + "O";
    }

    function draw(smiles, count) {
        if(typeof SmilesDrawer === 'undefined') {
            log("FEHLER: Kann nicht zeichnen, Lib fehlt!");
            return;
        }

        const cvs = document.getElementById('chemCanvas');
        
        // GRÃ–SSENBERECHNUNG (Verhindert das "Schrumpfen")
        // Wir machen den Canvas intern riesig.
        // Breite: Mindestens 800px, sonst 100px pro AminosÃ¤ure
        let w = Math.max(800, count * 100);
        // HÃ¶he: Fix auf 2000px. Das CSS-Fenster zeigt nur 600px davon mit Scrollbar.
        let h = 2000;

        // WICHTIG: Attribute setzen
        cvs.width = w;
        cvs.height = h;

        // Drawer Optionen
        let opts = {
            width: w,
            height: h,
            bondThickness: 1.0,
            bondLength: 22,   
            shortBondLength: 0.85,
            fontSize: 11,
            padding: 50,
            experimentalSSSR: true, // Hilft bei Ringen
            debug: false
        };

        // Neu instanziieren fÃ¼r sauberen State
        drawer = new SmilesDrawer.Drawer(opts);

        SmilesDrawer.parse(smiles, function(tree) {
            log("Zeichne MolekÃ¼l...");
            drawer.draw(tree, 'chemCanvas', 'light', false);
        }, function(err) {
            log("Parse Fehler: " + err);
        });
    }

    // Helpers
    window.copyToClip = (id) => {
        let t = document.getElementById(id).innerText;
        navigator.clipboard.writeText(t).then(()=>alert("Kopiert!"));
    }
    window.copyImage = () => {
        document.getElementById('chemCanvas').toBlob(blob => {
            try {
                navigator.clipboard.write([new ClipboardItem({"image/png":blob})]);
                alert("Bild kopiert!");
            } catch(e) { alert("Fehler: Browser blockiert Bild-Kopie."); }
        });
    }

    // Start nach dem Laden
    window.onload = init;

</script>
</body>
</html>
