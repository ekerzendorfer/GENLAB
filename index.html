<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Translation Labor</title>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        h2 { font-size: 1.2rem; color: var(--primary-color); margin-top: 0; }
        
        .aa-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background: #fff;
            transition: transform 0.2s;
        }
        .aa-card:hover { transform: scale(1.02); border-color: var(--accent-color); }
        .aa-header { display: flex; justify-content: space-between; align-items: baseline; font-weight: bold; }
        .aa-codons { font-size: 0.8rem; color: #666; margin-top: 5px; word-break: break-all;}

        /* --- MAIN CONTENT --- */
        #main {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .input-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            position: relative;
        }

        /* System Status Indikator */
        #sysStatus {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 0.8rem;
            color: #ccc;
        }

        .dna-input {
            width: 100%;
            font-family: 'Courier New', Courier, monospace;
            font-size: 2rem;
            letter-spacing: 2px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-transform: uppercase;
            color: var(--primary-color);
        }
        .dna-input:focus { border-color: var(--accent-color); outline: none; }
        .dna-input.error { border-color: #e74c3c; background-color: #fdeaea; }

        .vis-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* Das Anzeigefenster: Jetzt hÃ¶her (600px) */
        .chem-scroll-container {
            overflow: auto; 
            width: 100%;
            height: 600px; 
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            margin-bottom: 15px;
            background: white;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) #f0f0f0;
            position: relative;
        }
        
        #chemCanvas {
            display: block;
            margin: 20px; 
        }

        /* Output Zeilen */
        .seq-row {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .seq-label { width: 100px; font-weight: bold; color: #555; flex-shrink: 0; }
        .seq-content { font-size: 1.1rem; color: var(--primary-color); }
        
        .code-box {
            background: #eee;
            padding: 5px 10px;
            border-radius: 4px;
            user-select: all;
        }
        
        /* Buttons */
        .action-area {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .btn {
            background: var(--accent-color);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { background: #2980b9; }
        .btn-green { background: #27ae60; }
        .btn-green:hover { background: #219150; }
        .btn-purple { background: #8e44ad; }
        .btn-purple:hover { background: #732d91; }

    </style>
</head>
<body>

    <div id="sidebar">
        <h2>AminosÃ¤uren</h2>
        <div id="aa-list">Lade...</div>
    </div>

    <div id="main">
        <div class="input-section">
            <div id="sysStatus">Initialisiere...</div>
            <h3>Genetischer Code (DNA)</h3>
            <input type="text" id="dnaInput" class="dna-input" placeholder="ACG TCC ..." spellcheck="false" autocomplete="off">
            <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 5px;">
                Gib Tripletts ein (A, C, G, T). Leertaste wird automatisch gesetzt.
            </div>
            <div id="statusMsg" style="height: 20px; color: #e74c3c; font-weight: bold; margin-top: 5px;"></div>
        </div>

        <div class="vis-section">
            <h3>Polypeptid-Kette</h3>
            
            <div class="chem-scroll-container">
                <canvas id="chemCanvas"></canvas>
            </div>

            <div class="seq-row">
                <span class="seq-label">3-Letter:</span>
                <span id="seq3" class="seq-content">-</span>
            </div>
            <div class="seq-row">
                <span class="seq-label">FASTA:</span>
                <span id="seq1" class="seq-content code-box">-</span>
            </div>
            <div class="seq-row">
                <span class="seq-label">SMILES:</span>
                <span id="seqSmiles" class="seq-content code-box" style="font-size: 0.8rem; overflow:hidden; text-overflow:ellipsis;">-</span>
            </div>

            <div class="action-area">
                <button class="btn btn-green" id="btnCopyFasta">FASTA kopieren</button>
                <button class="btn btn-green" id="btnCopySmiles">SMILES kopieren</button>
                <button class="btn btn-purple" id="btnCopyImg" title="Kopiert Bild in Zwischenablage">ðŸ“· Bild kopieren</button>
                <div style="flex-grow:1"></div>
                <a href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/main/AlphaFold2.ipynb" target="_blank" class="btn">
                    ColabFold Notebook â†—
                </a>
            </div>
        </div>
    </div>

<script>
// Hauptprogramm startet erst wenn Seite geladen ist
window.onload = function() {
    
    // --- 1. SETUP & DATEN ---
    const sysStatus = document.getElementById('sysStatus');
    
    // Check ob Bibliothek da ist
    if (typeof SmilesDrawer === 'undefined') {
        sysStatus.innerText = "Fehler: SmilesDrawer Lib nicht geladen!";
        sysStatus.style.color = "red";
        return;
    } else {
        sysStatus.innerText = "System: Bereit";
        sysStatus.style.color = "green";
    }

    const aaData = {
        'A': { name: 'Alanin', code3: 'Ala', codons: ['GCT','GCC','GCA','GCG'], smiles: 'C' },
        'R': { name: 'Arginin', code3: 'Arg', codons: ['CGT','CGC','CGA','CGG','AGA','AGG'], smiles: 'CCCNC(=N)N' },
        'N': { name: 'Asparagin', code3: 'Asn', codons: ['AAT','AAC'], smiles: 'CC(=O)N' },
        'D': { name: 'AsparaginsÃ¤ure', code3: 'Asp', codons: ['GAT','GAC'], smiles: 'CC(=O)O' },
        'C': { name: 'Cystein', code3: 'Cys', codons: ['TGT','TGC'], smiles: 'CS' },
        'Q': { name: 'Glutamin', code3: 'Gln', codons: ['CAA','CAG'], smiles: 'CCC(=O)N' },
        'E': { name: 'GlutaminsÃ¤ure', code3: 'Glu', codons: ['GAA','GAG'], smiles: 'CCC(=O)O' },
        'G': { name: 'Glycin', code3: 'Gly', codons: ['GGT','GGC','GGA','GGG'], smiles: '' },
        'H': { name: 'Histidin', code3: 'His', codons: ['CAT','CAC'], smiles: 'CC1=CN=CN1' },
        'I': { name: 'Isoleucin', code3: 'Ile', codons: ['ATT','ATC','ATA'], smiles: 'C(C)CC' },
        'L': { name: 'Leucin', code3: 'Leu', codons: ['TTA','TTG','CTT','CTC','CTA','CTG'], smiles: 'CC(C)C' },
        'K': { name: 'Lysin', code3: 'Lys', codons: ['AAA','AAG'], smiles: 'CCCCN' },
        'M': { name: 'Methionin', code3: 'Met', codons: ['ATG'], smiles: 'CCSC' },
        'F': { name: 'Phenylalanin', code3: 'Phe', codons: ['TTT','TTC'], smiles: 'CC1=CC=CC=C1' },
        'P': { name: 'Prolin', code3: 'Pro', codons: ['CCT','CCC','CCA','CCG'], smiles: 'special' },
        'S': { name: 'Serin', code3: 'Ser', codons: ['TCT','TCC','TCA','TCG','AGT','AGC'], smiles: 'CO' },
        'T': { name: 'Threonin', code3: 'Thr', codons: ['ACT','ACC','ACA','ACG'], smiles: 'C(O)C' },
        'W': { name: 'Tryptophan', code3: 'Trp', codons: ['TGG'], smiles: 'CC1=CNC2=CC=CC=C12' },
        'Y': { name: 'Tyrosin', code3: 'Tyr', codons: ['TAT','TAC'], smiles: 'CC1=CC=C(O)C=C1' },
        'V': { name: 'Valin', code3: 'Val', codons: ['GTT','GTC','GTA','GTG'], smiles: 'C(C)C' },
        'STOP': { name: 'STOP', code3: '***', codons: ['TAA','TAG','TGA'], smiles: null }
    };

    const codonTable = {};
    for (let aa in aaData) {
        aaData[aa].codons.forEach(codon => { codonTable[codon] = aa; });
    }

    // --- 2. GUI ELEMENTE ---
    const sidebar = document.getElementById('aa-list');
    const dnaInput = document.getElementById('dnaInput');
    const statusMsg = document.getElementById('statusMsg');
    const chemCanvas = document.getElementById('chemCanvas');
    
    // Output Felder
    const seq3 = document.getElementById('seq3');
    const seq1 = document.getElementById('seq1');
    const seqSmiles = document.getElementById('seqSmiles');

    // Sidebar befÃ¼llen
    sidebar.innerHTML = '';
    Object.keys(aaData).sort().forEach(key => {
        if(key === 'STOP') return;
        const data = aaData[key];
        const card = document.createElement('div');
        card.className = 'aa-card';
        card.innerHTML = `
            <div class="aa-header"><span>${data.name}</span><span>${key} / ${data.code3}</span></div>
            <div class="aa-codons">${data.codons.join(', ')}</div>
        `;
        sidebar.appendChild(card);
    });

    // --- 3. LOGIK ---

    dnaInput.addEventListener('input', (e) => {
        let raw = e.target.value.toUpperCase().replace(/[^ACGT]/g, '');
        let formatted = '';
        for (let i = 0; i < raw.length; i++) {
            if (i > 0 && i % 3 === 0) formatted += ' ';
            formatted += raw[i];
        }
        if (dnaInput.value !== formatted) dnaInput.value = formatted;
        
        translateAndDraw(raw);
    });

    // Buttons
    document.getElementById('btnCopyFasta').onclick = () => copyText(seq1.innerText, "FASTA");
    document.getElementById('btnCopySmiles').onclick = () => copyText(seqSmiles.innerText, "SMILES");
    
    document.getElementById('btnCopyImg').onclick = function() {
        chemCanvas.toBlob(function(blob) {
            try {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]);
                alert("Bild kopiert!");
            } catch (err) {
                alert("Browser-Sicherheit verbietet Bild-Kopie bei lokaler Datei. Bitte Screenshot nutzen.");
            }
        });
    };

    function copyText(txt, name) {
        if(!txt || txt === '-') return;
        navigator.clipboard.writeText(txt).then(() => alert(name + " kopiert!"));
    }

    function translateAndDraw(dnaSequence) {
        const triplets = dnaSequence.match(/.{1,3}/g) || [];
        let aaSequence = [];
        let aa3List = [];
        
        statusMsg.innerText = "";
        dnaInput.classList.remove('error');

        for (let t of triplets) {
            if (t.length < 3) continue;
            const aaCode = codonTable[t];
            if (!aaCode) {
                statusMsg.innerText = `Unbekannt: ${t}`;
                dnaInput.classList.add('error');
                continue;
            }
            if (aaCode === 'STOP') break;
            aaSequence.push(aaCode);
            aa3List.push(aaData[aaCode].code3);
        }

        // Text Updates
        seq3.innerText = aa3List.join(' - ');
        seq1.innerText = aaSequence.join('');
        
        if (aaSequence.length > 0) {
            try {
                const smiles = generatePeptideSmiles(aaSequence);
                seqSmiles.innerText = smiles;
                drawOnCanvas(smiles, aaSequence.length);
            } catch (e) {
                console.error(e);
                statusMsg.innerText = "Fehler beim Zeichnen.";
            }
        } else {
            seqSmiles.innerText = "-";
            clearCanvas();
        }
    }

    function generatePeptideSmiles(sequence) {
        let smiles = "";
        sequence.forEach((aa) => {
            let fragment = "";
            if (aa === 'P') fragment = "N1[C@@H](CCC1)C(=O)";
            else if (aa === 'G') fragment = "NCC(=O)";
            else fragment = `N[C@@H](${aaData[aa].smiles})C(=O)`;
            smiles += fragment;
        });
        smiles += "O";
        return smiles;
    }

    function drawOnCanvas(smiles, count) {
        // --- GRÃ–SSENBERECHNUNG (Anti-Zoom) ---
        // Breite: Genug Platz pro AS (80px)
        let w = Math.max(800, count * 80);
        // HÃ¶he: Riesig (2500px), damit nichts gestaucht wird
        // Das Sichtfenster ist per CSS auf 600px begrenzt (Scrollbar)
        let h = 2500; 

        chemCanvas.width = w;
        chemCanvas.height = h;

        let options = {
            bondThickness: 1.0,
            bondLength: 22,    // Optimierte LÃ¤nge
            shortBondLength: 0.85,
            fontSize: 10,       
            backgroundColor: 'transparent',
            padding: 40,
            width: w,
            height: h,
            experimentalSSSR: true
        };

        let drawer = new SmilesDrawer.Drawer(options);
        
        SmilesDrawer.parse(smiles, function(tree) {
            drawer.draw(tree, 'chemCanvas', 'light', false);
        });
    }

    function clearCanvas() {
        const ctx = chemCanvas.getContext('2d');
        chemCanvas.width = 800;
        chemCanvas.height = 600;
        ctx.font = "16px Arial";
        ctx.fillStyle = "#aaa";
        ctx.clearRect(0,0,800,600);
        ctx.fillText("Warte auf Eingabe...", 30, 300);
    }

    // Start
    clearCanvas();
};
</script>
</body>
</html>
