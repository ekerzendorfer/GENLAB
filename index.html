<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Translation Labor</title>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: var(--bg-color);
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        h2 { font-size: 1.2rem; color: var(--primary-color); margin-top: 0; }
        
        .aa-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background: #fff;
            transition: transform 0.2s;
        }
        .aa-card:hover { transform: scale(1.02); border-color: var(--accent-color); }
        .aa-header { display: flex; justify-content: space-between; align-items: baseline; font-weight: bold; }
        .aa-codons { font-size: 0.8rem; color: #666; margin-top: 5px; word-break: break-all;}

        /* --- MAIN CONTENT --- */
        #main {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Input Area */
        .input-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .dna-input {
            width: 100%;
            font-family: 'Courier New', Courier, monospace;
            font-size: 2rem;
            letter-spacing: 2px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-transform: uppercase;
            color: var(--primary-color);
        }
        .dna-input:focus { border-color: var(--accent-color); outline: none; }
        .dna-input.error { border-color: #e74c3c; background-color: #fdeaea; }

        .hint { font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; }

        /* Visualization Area */
        .vis-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* Scrollable Container */
        .chem-scroll-container {
            overflow: auto; 
            width: 100%;
            height: 600px; /* Deutlich h√∂her f√ºr quadratische Ansicht */
            border: 1px solid #f0f0f0;
            border-radius: 5px;
            margin-bottom: 15px;
            background: white;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) #f0f0f0;
            position: relative;
        }
        
        #chemCanvas {
            display: block;
            margin: 20px; 
        }

        /* Sequences */
        .seq-row {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            white-space: nowrap;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .seq-label { width: 100px; font-weight: bold; color: #555; flex-shrink: 0; }
        .seq-content { font-size: 1.1rem; color: var(--primary-color); }
        
        .code-box {
            background: #eee;
            padding: 5px 10px;
            border-radius: 4px;
            user-select: all;
        }
        
        /* Buttons */
        .action-area {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .btn {
            background: var(--accent-color);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { background: #2980b9; }
        .btn-copy { background: #27ae60; }
        .btn-copy:hover { background: #219150; }
        .btn-img { background: #8e44ad; }
        .btn-img:hover { background: #732d91; }

    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Aminos√§uren</h2>
        <div id="aa-list">Lade Daten...</div>
    </div>

    <div id="main">
        <div class="input-section">
            <h3>Genetischer Code (DNA)</h3>
            <input type="text" id="dnaInput" class="dna-input" placeholder="ACG TCC ..." spellcheck="false" autocomplete="off">
            <div class="hint">Gib Tripletts ein (A, C, G, T). Leertaste wird automatisch gesetzt.</div>
            <div id="statusMsg" style="height: 20px; color: #e74c3c; font-weight: bold; margin-top: 5px;"></div>
        </div>

        <div class="vis-section">
            <h3>Polypeptid-Kette</h3>
            
            <div class="chem-scroll-container" id="chemContainer">
                <canvas id="chemCanvas"></canvas>
            </div>

            <div class="seq-row">
                <span class="seq-label">3-Letter:</span>
                <span id="seq3" class="seq-content">-</span>
            </div>
            <div class="seq-row">
                <span class="seq-label">FASTA:</span>
                <span id="seq1" class="seq-content code-box">-</span>
            </div>
            <div class="seq-row">
                <span class="seq-label">SMILES:</span>
                <span id="seqSmiles" class="seq-content code-box" style="font-size: 0.8rem; overflow:hidden; text-overflow:ellipsis;">-</span>
            </div>

            <div class="action-area">
                <button class="btn btn-copy" id="btnCopyFasta">FASTA kopieren</button>
                <button class="btn btn-copy" id="btnCopySmiles">SMILES kopieren</button>
                <button class="btn btn-img" id="btnCopyImg" title="Kopiert das Strukturbild in die Zwischenablage">üì∑ Bild kopieren</button>
                <div style="flex-grow:1"></div> <a href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/main/AlphaFold2.ipynb" target="_blank" class="btn">
                    ColabFold Notebook ‚Üó
                </a>
            </div>
        </div>
    </div>

<script>
window.addEventListener('load', function() {

    // 1. DATEN DEFINITION
    const aaData = {
        'A': { name: 'Alanin', code3: 'Ala', codons: ['GCT','GCC','GCA','GCG'], smiles: 'C' },
        'R': { name: 'Arginin', code3: 'Arg', codons: ['CGT','CGC','CGA','CGG','AGA','AGG'], smiles: 'CCCNC(=N)N' },
        'N': { name: 'Asparagin', code3: 'Asn', codons: ['AAT','AAC'], smiles: 'CC(=O)N' },
        'D': { name: 'Asparagins√§ure', code3: 'Asp', codons: ['GAT','GAC'], smiles: 'CC(=O)O' },
        'C': { name: 'Cystein', code3: 'Cys', codons: ['TGT','TGC'], smiles: 'CS' },
        'Q': { name: 'Glutamin', code3: 'Gln', codons: ['CAA','CAG'], smiles: 'CCC(=O)N' },
        'E': { name: 'Glutamins√§ure', code3: 'Glu', codons: ['GAA','GAG'], smiles: 'CCC(=O)O' },
        'G': { name: 'Glycin', code3: 'Gly', codons: ['GGT','GGC','GGA','GGG'], smiles: '' },
        'H': { name: 'Histidin', code3: 'His', codons: ['CAT','CAC'], smiles: 'CC1=CN=CN1' },
        'I': { name: 'Isoleucin', code3: 'Ile', codons: ['ATT','ATC','ATA'], smiles: 'C(C)CC' },
        'L': { name: 'Leucin', code3: 'Leu', codons: ['TTA','TTG','CTT','CTC','CTA','CTG'], smiles: 'CC(C)C' },
        'K': { name: 'Lysin', code3: 'Lys', codons: ['AAA','AAG'], smiles: 'CCCCN' },
        'M': { name: 'Methionin', code3: 'Met', codons: ['ATG'], smiles: 'CCSC' },
        'F': { name: 'Phenylalanin', code3: 'Phe', codons: ['TTT','TTC'], smiles: 'CC1=CC=CC=C1' },
        'P': { name: 'Prolin', code3: 'Pro', codons: ['CCT','CCC','CCA','CCG'], smiles: 'special' },
        'S': { name: 'Serin', code3: 'Ser', codons: ['TCT','TCC','TCA','TCG','AGT','AGC'], smiles: 'CO' },
        'T': { name: 'Threonin', code3: 'Thr', codons: ['ACT','ACC','ACA','ACG'], smiles: 'C(O)C' },
        'W': { name: 'Tryptophan', code3: 'Trp', codons: ['TGG'], smiles: 'CC1=CNC2=CC=CC=C12' },
        'Y': { name: 'Tyrosin', code3: 'Tyr', codons: ['TAT','TAC'], smiles: 'CC1=CC=C(O)C=C1' },
        'V': { name: 'Valin', code3: 'Val', codons: ['GTT','GTC','GTA','GTG'], smiles: 'C(C)C' },
        'STOP': { name: 'STOP', code3: '***', codons: ['TAA','TAG','TGA'], smiles: null }
    };

    const codonTable = {};
    for (let aa in aaData) {
        aaData[aa].codons.forEach(codon => {
            codonTable[codon] = aa;
        });
    }

    // 2. SIDEBAR
    const sidebar = document.getElementById('aa-list');
    sidebar.innerHTML = '';
    
    Object.keys(aaData).sort().forEach(key => {
        if(key === 'STOP') return;
        const data = aaData[key];
        const card = document.createElement('div');
        card.className = 'aa-card';
        card.innerHTML = `
            <div class="aa-header">
                <span>${data.name}</span>
                <span>${key} / ${data.code3}</span>
            </div>
            <div class="aa-codons">${data.codons.join(', ')}</div>
        `;
        sidebar.appendChild(card);
    });

    // 3. ELEMENTE
    const dnaInput = document.getElementById('dnaInput');
    const statusMsg = document.getElementById('statusMsg');
    const chemCanvas = document.getElementById('chemCanvas');
    const seq3 = document.getElementById('seq3');
    const seq1 = document.getElementById('seq1');
    const seqSmiles = document.getElementById('seqSmiles');
    
    // Buttons
    const btnCopyFasta = document.getElementById('btnCopyFasta');
    const btnCopySmiles = document.getElementById('btnCopySmiles');
    const btnCopyImg = document.getElementById('btnCopyImg');

    // 4. LOGIK
    dnaInput.addEventListener('input', (e) => {
        let raw = e.target.value.toUpperCase().replace(/[^ACGT]/g, '');
        let formatted = '';
        for (let i = 0; i < raw.length; i++) {
            if (i > 0 && i % 3 === 0) formatted += ' ';
            formatted += raw[i];
        }
        if (dnaInput.value !== formatted) {
           dnaInput.value = formatted;
        }
        translateAndDraw(raw);
    });

    // Button Handler
    btnCopyFasta.addEventListener('click', () => {
        copyToClipboard(seq1.innerText, "FASTA kopiert!");
    });
    
    btnCopySmiles.addEventListener('click', () => {
        copyToClipboard(seqSmiles.innerText, "SMILES kopiert!");
    });

    btnCopyImg.addEventListener('click', () => {
        chemCanvas.toBlob(function(blob) {
            try {
                const item = new ClipboardItem({ "image/png": blob });
                navigator.clipboard.write([item]);
                alert("Bild in die Zwischenablage kopiert! (Strg+V zum Einf√ºgen)");
            } catch (err) {
                alert("Konnte Bild nicht kopieren. (Browser-Sicherheitseinstellungen?)");
            }
        });
    });

    function copyToClipboard(text, msg) {
        if(text === '-' || text === '') return;
        navigator.clipboard.writeText(text).then(() => alert(msg));
    }

    function translateAndDraw(dnaSequence) {
        const triplets = dnaSequence.match(/.{1,3}/g) || [];
        let aaSequence = [];
        let aa3List = [];
        
        statusMsg.innerText = "";
        dnaInput.classList.remove('error');

        for (let t of triplets) {
            if (t.length < 3) continue;
            const aaCode = codonTable[t];
            if (!aaCode) {
                statusMsg.innerText = `Ung√ºltiges Codon: ${t}`;
                dnaInput.classList.add('error');
                continue;
            }
            if (aaCode === 'STOP') break;
            aaSequence.push(aaCode);
            aa3List.push(aaData[aaCode].code3);
        }

        seq3.innerText = aa3List.join(' - ');
        seq1.innerText = aaSequence.join('');

        if (aaSequence.length > 0) {
            try {
                const peptideSmiles = generatePeptideSmiles(aaSequence);
                seqSmiles.innerText = peptideSmiles; // SMILES anzeigen
                drawStructure(peptideSmiles, aaSequence.length);
            } catch (e) {
                console.error("Zeichenfehler:", e);
                resetCanvas();
            }
        } else {
            seqSmiles.innerText = "-";
            resetCanvas();
        }
    }

    function generatePeptideSmiles(sequence) {
        let smiles = "";
        sequence.forEach((aa) => {
            let fragment = "";
            if (aa === 'P') {
                fragment = "N1[C@@H](CCC1)C(=O)";
            } else if (aa === 'G') {
                fragment = "NCC(=O)";
            } else {
                let rGroup = aaData[aa].smiles;
                fragment = `N[C@@H](${rGroup})C(=O)`;
            }
            smiles += fragment;
        });
        smiles += "O";
        return smiles;
    }

    function drawStructure(smiles, residueCount) {
        if (typeof SmilesDrawer === 'undefined') return;

        // --- OPTIMIERTE GR√ñSSENBERECHNUNG ---
        
        // Canvas Breite: Wir geben sehr viel Platz (80px pro AS), damit es horizontal nicht staucht.
        const widthPerResidue = 80; 
        let calcWidth = Math.max(800, residueCount * widthPerResidue);

        // Canvas H√∂he: MASSIV erh√∂hen.
        // Wenn das Molek√ºl faltet, braucht es Platz nach unten.
        // Das Fenster ist nur 600px hoch (CSS), aber der interne Canvas ist 2000px.
        // Dadurch muss SmilesDrawer nicht verkleinern, um alles unterzubringen.
        let calcHeight = Math.max(2000, residueCount * 50);

        chemCanvas.width = calcWidth;
        chemCanvas.height = calcHeight;

        let options = {
            bondThickness: 0.8,
            bondLength: 22,    // Leicht erh√∂ht f√ºr weniger √úberlagerung
            shortBondLength: 0.85,
            fontSize: 9,       
            backgroundColor: 'transparent',
            padding: 30,
            experimentalSSSR: true,
            width: calcWidth,
            height: calcHeight
        };

        let drawer = new SmilesDrawer.Drawer(options);
        
        SmilesDrawer.parse(smiles, function(tree) {
            drawer.draw(tree, 'chemCanvas', 'light', false);
        }, function(err) {
            console.log(err);
        });
    }

    function resetCanvas() {
        const ctx = chemCanvas.getContext('2d');
        chemCanvas.width = 800;
        chemCanvas.height = 600;
        ctx.font = "16px Arial";
        ctx.fillStyle = "#ccc";
        ctx.clearRect(0,0,800,600);
        ctx.fillText("Warte auf DNA-Eingabe...", 20, 300);
    }

    resetCanvas();

});
</script>
</body>
</html>
