<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GENLAB - DNA zu Peptid</title>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #2980b9;
            --bg: #ecf0f1;
            --header-bg: #fff;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column;
            height: 100vh; 
            background: var(--bg); 
            color: var(--primary);
        }

        /* --- HEADER --- */
        header {
            background: var(--header-bg);
            padding: 15px 20px;
            border-bottom: 3px solid var(--accent);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0;
            text-align: center;
        }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); letter-spacing: 1px; }
        h4 { margin: 5px 0 0 0; font-size: 0.9rem; color: var(--secondary); font-weight: normal; font-style: italic; }

        /* --- LAYOUT --- */
        .container {
            display: flex;
            flex-grow: 1;
            overflow: hidden; 
        }

        /* SIDEBAR */
        #sidebar { 
            width: 260px; 
            background: #fff; 
            border-right: 1px solid #ddd; 
            overflow-y: auto; 
            padding: 15px;
            flex-shrink: 0;
            display: none; 
        }
        @media (min-width: 800px) { #sidebar { display: block; } }

        .aa-card { 
            border: 1px solid #eee; 
            padding: 8px; 
            margin-bottom: 8px; 
            border-radius: 6px; 
            background: #fdfdfd; 
            font-size: 0.85rem;
            transition: 0.2s;
        }
        .aa-card:hover { border-color: var(--accent); transform: translateX(2px); }

        /* MAIN CONTENT */
        #main { 
            flex-grow: 1; 
            padding: 20px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }

        .card { 
            background: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }

        /* INPUT */
        .dna-input { 
            width: 100%; 
            font-family: 'Courier New', monospace; 
            font-size: 1.4rem; 
            padding: 8px; 
            border: 2px solid #bdc3c7; 
            border-radius: 4px; 
            text-transform: uppercase; 
            color: var(--primary);
            box-sizing: border-box; 
        }
        .dna-input:focus { border-color: var(--accent); outline: none; }
        .error-msg { color: #c0392b; font-size: 0.9rem; margin-top: 5px; height: 1.2em;}

        /* CHEMIE FENSTER */
        .chem-window {
            width: 100%;
            height: 400px; 
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            overflow: auto; /* Scrollbars */
            background: #ffffff;
            position: relative;
            margin-bottom: 10px;
            /* Sanftes Scrollen fÃ¼r den Auto-Focus */
            scroll-behavior: smooth;
        }
        
        #chemCanvas { display: block; }

        /* DATEN OUTPUT */
        .data-row { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin-bottom: 8px; 
            font-family: monospace; 
            font-size: 0.9rem; 
        }
        .label { font-weight: bold; min-width: 70px; color: #7f8c8d; }
        .value { 
            background: #f0f2f5; 
            padding: 4px 8px; 
            border-radius: 4px; 
            color: #2c3e50; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 100%;
        }

        /* BUTTONS */
        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        button { 
            padding: 8px 14px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            display: inline-flex; 
            align-items: center; 
            gap: 5px; 
            transition: 0.2s;
            color: white;
            background: var(--accent);
        }
        button:hover { filter: brightness(110%); }
        .btn-opt { background: #e67e22; }
        .btn-link { background: #27ae60; text-decoration: none; }
        
    </script>
</head>
<body>

    <header>
        <h1>GENLAB - vom genetischen Code zum Peptid</h1>
        <h4>Erstellt von Mag. Erich Kerzendorfer mit Hilfe von Gemini PRO</h4>
    </header>

    <div class="container">
        <div id="sidebar">
            <h3 style="margin-top:0; color:var(--secondary)">Bausteine</h3>
            <div id="aa-list">Lade...</div>
        </div>

        <div id="main">
            
            <div class="card">
                <h3 style="margin-top:0">1. Genetischer Code (DNA)</h3>
                <input type="text" id="dnaInput" class="dna-input" placeholder="GCT AAA ..." autocomplete="off">
                <div class="error-msg" id="statusMsg"></div>
                <div style="font-size:0.8rem; color:#95a5a6">Erlaubt: A, C, G, T. Leertasten automatisch.</div>
            </div>

            <div class="card" style="flex-grow:1; display:flex; flex-direction:column;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin-top:0">2. Struktur & Daten</h3>
                    <button class="btn-opt" onclick="forceOptimize()" title="Zeichnung neu berechnen und zentrieren">
                        ðŸª„ Optimieren & Zentrieren
                    </button>
                </div>

                <div class="chem-window" id="chemWindow">
                    <canvas id="chemCanvas"></canvas>
                </div>

                <div class="data-row"><span class="label">3-Letter:</span> <span id="out3" class="value">-</span></div>
                <div class="data-row"><span class="label">FASTA:</span> <span id="out1" class="value">-</span></div>
                <div class="data-row"><span class="label">SMILES:</span> <span id="outSmiles" class="value" style="font-size:0.75rem">-</span></div>

                <div class="btn-group">
                    <button onclick="copyToClip('out1')">ðŸ“„ FASTA kopieren</button>
                    <button onclick="copyToClip('outSmiles')">ðŸ§ª SMILES kopieren</button>
                    <button onclick="copyImg()">ðŸ“· Bild kopieren</button>
                    <div style="flex-grow:1"></div>
                    <a href="https://colab.research.google.com/github/sokrypton/ColabFold/blob/main/AlphaFold2.ipynb" target="_blank" class="btn-link" style="color:white; padding: 8px 14px; border-radius: 5px;">
                        ðŸš€ ColabFold â†—
                    </a>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DATEN ---
    const aaData = {
        'A': {n:'Alanin', c:['GCT','GCC','GCA','GCG'], s:'C'},
        'R': {n:'Arginin', c:['CGT','CGC','CGA','CGG','AGA','AGG'], s:'CCCNC(=N)N'},
        'N': {n:'Asparagin', c:['AAT','AAC'], s:'CC(=O)N'},
        'D': {n:'AsparaginsÃ¤ure', c:['GAT','GAC'], s:'CC(=O)O'},
        'C': {n:'Cystein', c:['TGT','TGC'], s:'CS'},
        'Q': {n:'Glutamin', c:['CAA','CAG'], s:'CCC(=O)N'},
        'E': {n:'GlutaminsÃ¤ure', c:['GAA','GAG'], s:'CCC(=O)O'},
        'G': {n:'Glycin', c:['GGT','GGC','GGA','GGG'], s:''},
        'H': {n:'Histidin', c:['CAT','CAC'], s:'CC1=CN=CN1'},
        'I': {n:'Isoleucin', c:['ATT','ATC','ATA'], s:'C(C)CC'},
        'L': {n:'Leucin', c:['TTA','TTG','CTT','CTC','CTA','CTG'], s:'CC(C)C'},
        'K': {n:'Lysin', c:['AAA','AAG'], s:'CCCCN'},
        'M': {n:'Methionin', c:['ATG'], s:'CCSC'},
        'F': {n:'Phenylalanin', c:['TTT','TTC'], s:'CC1=CC=CC=C1'},
        'P': {n:'Prolin', c:['CCT','CCC','CCA','CCG'], s:'special'},
        'S': {n:'Serin', c:['TCT','TCC','TCA','TCG','AGT','AGC'], s:'CO'},
        'T': {n:'Threonin', c:['ACT','ACC','ACA','ACG'], s:'C(O)C'},
        'W': {n:'Tryptophan', c:['TGG'], s:'CC1=CNC2=CC=CC=C12'},
        'Y': {n:'Tyrosin', c:['TAT','TAC'], s:'CC1=CC=C(O)C=C1'},
        'V': {n:'Valin', c:['GTT','GTC','GTA','GTG'], s:'C(C)C'},
        'STOP': {n:'STOP', c:['TAA','TAG','TGA'], s:null}
    };

    const codonTable = {};
    for (let k in aaData) { aaData[k].c.forEach(cod => codonTable[cod] = k); }

    let currentSmiles = "";
    let currentCount = 0;

    // --- INIT ---
    window.onload = function() {
        const sb = document.getElementById('aa-list');
        sb.innerHTML = "";
        Object.keys(aaData).sort().forEach(k => {
            if(k==='STOP') return;
            sb.innerHTML += `
                <div class="aa-card">
                    <div class="aa-header"><span>${aaData[k].n}</span><span>${k}</span></div>
                    <div style="color:#666">${aaData[k].c.join(', ')}</div>
                </div>`;
        });
        resetCanvas();
    };

    // --- LOGIC ---
    const dnaInput = document.getElementById('dnaInput');
    
    dnaInput.addEventListener('input', (e) => {
        let raw = e.target.value.toUpperCase().replace(/[^ACGT]/g, '');
        let fmt = raw.replace(/(.{3})/g, '$1 ').trim();
        if(dnaInput.value !== fmt) dnaInput.value = fmt;
        processDNA(raw);
    });

    function processDNA(raw) {
        const triplets = raw.match(/.{1,3}/g) || [];
        let seq = [];
        let seq3 = [];
        let error = "";

        for(let t of triplets) {
            if(t.length < 3) continue;
            let aa = codonTable[t];
            if(!aa) { error = "Unbekannt: " + t; continue; }
            if(aa === 'STOP') break;
            seq.push(aa);
            seq3.push(aaData[aa].n.substring(0,3));
        }

        document.getElementById('statusMsg').innerText = error;
        document.getElementById('out3').innerText = seq3.join(' - ');
        document.getElementById('out1').innerText = seq.join('');
        
        if(seq.length > 0) {
            currentSmiles = buildSmiles(seq);
            currentCount = seq.length;
            document.getElementById('outSmiles').innerText = currentSmiles;
            draw(currentSmiles, currentCount, false);
        } else {
            resetCanvas();
        }
    }

    function buildSmiles(seq) {
        let s = "";
        seq.forEach(aa => {
            if(aa === 'P') s += "N1[C@@H](CCC1)C(=O)";
            else if(aa === 'G') s += "NCC(=O)";
            else s += `N[C@@H](${aaData[aa].s})C(=O)`;
        });
        return s + "O";
    }

    // --- DRAWING ENGINE ---
    function draw(smiles, count, optimize) {
        if(typeof SmilesDrawer === 'undefined') return;

        const cvs = document.getElementById('chemCanvas');
        const win = document.getElementById('chemWindow');
        
        // GRÃ–SSENBERECHNUNG
        // 1. Breite: Wachsend mit der Kette
        let pxPerResidue = optimize ? 80 : 60;
        let w = Math.max(600, count * pxPerResidue);
        
        // 2. HÃ¶he: Fest auf 600px.
        // Das ist hoch genug fÃ¼r moderate Faltungen, aber klein genug, damit wir die Mitte finden.
        // Das Sichtfenster ist 400px hoch.
        let h = 600;

        cvs.width = w;
        cvs.height = h;

        let options = {
            width: w,
            height: h,
            bondThickness: 1.0,
            bondLength: optimize ? 25 : 18, 
            shortBondLength: 0.85,
            fontSize: optimize ? 12 : 10,
            padding: 20,
            experimentalSSSR: true,
            overlapResolutionIterations: optimize ? 10 : 1
        };

        let drawer = new SmilesDrawer.Drawer(options);
        
        SmilesDrawer.parse(smiles, function(tree) {
            drawer.draw(tree, 'chemCanvas', 'light', false);
            
            // --- AUTO-CENTER LOGIC ---
            // Wir scrollen das Fenster so, dass die vertikale Mitte des Canvas (300px)
            // in der Mitte des Sichtfensters (200px) liegt.
            // Ziel-Scroll-Position = (CanvasHÃ¶he / 2) - (FensterHÃ¶he / 2)
            // = 300 - 200 = 100px.
            
            setTimeout(() => {
                const scrollTopPos = (h / 2) - (win.clientHeight / 2);
                win.scrollTop = scrollTopPos;
                // Optional: Horizontal zum Anfang scrollen (oder auch Mitte)
                // win.scrollLeft = 0; 
            }, 50); // Kleiner Timeout fÃ¼r Browser-Rendering
            
        });
    }

    window.forceOptimize = function() {
        if(!currentSmiles) return;
        draw(currentSmiles, currentCount, true);
    };

    function resetCanvas() {
        const cvs = document.getElementById('chemCanvas');
        cvs.width = 600; cvs.height = 400;
        const ctx = cvs.getContext('2d');
        ctx.font = "16px sans-serif";
        ctx.fillStyle = "#bdc3c7";
        ctx.fillText("Bitte DNA eingeben...", 20, 200);
        document.getElementById('outSmiles').innerText = "-";
        currentSmiles = "";
    }

    // --- TOOLS ---
    window.copyToClip = (id) => {
        let t = document.getElementById(id).innerText;
        if(t && t !== '-') navigator.clipboard.writeText(t).then(()=>alert("Kopiert!"));
    };
    window.copyImg = () => {
        const cvs = document.getElementById('chemCanvas');
        cvs.toBlob(b => {
            try { navigator.clipboard.write([new ClipboardItem({"image/png":b})]); alert("Bild kopiert!"); }
            catch(e) { alert("Browser verbietet Bild-Kopie."); }
        });
    };
</script>
</body>
</html>
