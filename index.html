<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA Translation Labor</title>
    <script src="https://unpkg.com/smiles-drawer@2.0.1/dist/smiles-drawer.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f7f6; }
        
        /* Sidebar */
        #sidebar { width: 250px; background: white; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; }
        .aa-card { border: 1px solid #eee; padding: 8px; margin-bottom: 8px; border-radius: 4px; font-size: 0.9rem; background: #fff;}
        .aa-header { font-weight: bold; display: flex; justify-content: space-between; color: #2c3e50; }

        /* Main */
        #main { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Input */
        .box { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .dna-input { width: 100%; font-family: monospace; font-size: 1.5rem; letter-spacing: 2px; padding: 8px; border: 2px solid #ddd; text-transform: uppercase; }
        
        /* Visualisierung */
        .vis-container { 
            flex-grow: 1; 
            background: white; 
            border-radius: 8px; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* Wichtig fÃ¼r Scrollbereich */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Das Fenster, durch das wir schauen */
        .chem-scroll-window {
            flex-grow: 1;
            overflow: auto; /* Scrollbalken erlauben */
            border: 1px solid #eee;
            background: #ffffff;
            position: relative;
            margin-bottom: 10px;
        }

        #chemCanvas {
            display: block;
            background-color: #ffffff; /* WeiÃŸer Hintergrund erzwingen */
        }

        /* Output Zeilen */
        .row { display: flex; align-items: center; gap: 10px; margin-top: 5px; font-family: monospace; font-size: 0.9rem; }
        .label { font-weight: bold; width: 80px; color: #555; }
        .data { background: #eee; padding: 4px 8px; border-radius: 4px; color: #333; }

        /* Buttons */
        .btn-row { margin-top: 10px; display: flex; gap: 10px; }
        button { padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; background: #3498db; }
        button:hover { background: #2980b9; }
        .btn-test { background: #e67e22; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h3>AminosÃ¤uren</h3>
        <div id="aa-list">Lade...</div>
    </div>

    <div id="main">
        <div class="box">
            <h3>Genetischer Code</h3>
            <input type="text" id="dnaInput" class="dna-input" placeholder="ACG TCC ..." autocomplete="off">
            <div style="margin-top:5px; font-size:0.8rem; color:red; font-weight:bold" id="errorMsg"></div>
        </div>

        <div class="vis-container">
            <h3>Strukturformel</h3>
            
            <div class="chem-scroll-window">
                <canvas id="chemCanvas"></canvas>
            </div>

            <div class="row"><span class="label">3-Letter:</span> <span id="out3" class="data">-</span></div>
            <div class="row"><span class="label">FASTA:</span> <span id="out1" class="data">-</span></div>
            <div class="row"><span class="label">SMILES:</span> <span id="outSmiles" class="data" style="font-size: 0.7rem; max-width: 600px; overflow: hidden; text-overflow: ellipsis;">-</span></div>
            
            <div class="btn-row">
                <button onclick="copyToClip('out1')">FASTA kopieren</button>
                <button onclick="copyToClip('outSmiles')">SMILES kopieren</button>
                <button onclick="copyImg()">ðŸ“· Bild kopieren</button>
                <div style="flex-grow:1"></div>
                <button class="btn-test" onclick="drawTestMolecule()">ðŸ§ª Test: Koffein zeichnen</button>
            </div>
        </div>
    </div>

<script>
    // --- DATEN ---
    const aaData = {
        'A': {n:'Ala', c:['GCT','GCC','GCA','GCG'], s:'C'},
        'R': {n:'Arg', c:['CGT','CGC','CGA','CGG','AGA','AGG'], s:'CCCNC(=N)N'},
        'N': {n:'Asn', c:['AAT','AAC'], s:'CC(=O)N'},
        'D': {n:'Asp', c:['GAT','GAC'], s:'CC(=O)O'},
        'C': {n:'Cys', c:['TGT','TGC'], s:'CS'},
        'Q': {n:'Gln', c:['CAA','CAG'], s:'CCC(=O)N'},
        'E': {n:'Glu', c:['GAA','GAG'], s:'CCC(=O)O'},
        'G': {n:'Gly', c:['GGT','GGC','GGA','GGG'], s:''},
        'H': {n:'His', c:['CAT','CAC'], s:'CC1=CN=CN1'},
        'I': {n:'Ile', c:['ATT','ATC','ATA'], s:'C(C)CC'},
        'L': {n:'Leu', c:['TTA','TTG','CTT','CTC','CTA','CTG'], s:'CC(C)C'},
        'K': {n:'Lys', c:['AAA','AAG'], s:'CCCCN'},
        'M': {n:'Met', c:['ATG'], s:'CCSC'},
        'F': {n:'Phe', c:['TTT','TTC'], s:'CC1=CC=CC=C1'},
        'P': {n:'Pro', c:['CCT','CCC','CCA','CCG'], s:'special'},
        'S': {n:'Ser', c:['TCT','TCC','TCA','TCG','AGT','AGC'], s:'CO'},
        'T': {n:'Thr', c:['ACT','ACC','ACA','ACG'], s:'C(O)C'},
        'W': {n:'Trp', c:['TGG'], s:'CC1=CNC2=CC=CC=C12'},
        'Y': {n:'Tyr', c:['TAT','TAC'], s:'CC1=CC=C(O)C=C1'},
        'V': {n:'Val', c:['GTT','GTC','GTA','GTG'], s:'C(C)C'},
        'STOP': {n:'STOP', c:['TAA','TAG','TGA'], s:null}
    };

    const codonTable = {};
    for (let k in aaData) { aaData[k].c.forEach(c => codonTable[c] = k); }

    // --- SETUP ---
    const dnaInput = document.getElementById('dnaInput');
    const chemCanvas = document.getElementById('chemCanvas');
    let drawer = null;

    // Init Sidebar
    const sb = document.getElementById('aa-list');
    sb.innerHTML = "";
    Object.keys(aaData).sort().forEach(k => {
        if(k==='STOP') return;
        sb.innerHTML += `<div class="aa-card"><div class="aa-header"><span>${aaData[k].n}</span><span>${k}</span></div><div style="font-size:0.8em; color:#666">${aaData[k].c.join(', ')}</div></div>`;
    });

    // Start-Setup fÃ¼r Canvas
    chemCanvas.width = 800;
    chemCanvas.height = 500;
    const ctx = chemCanvas.getContext('2d');
    ctx.font = "20px Arial";
    ctx.fillStyle = "#999";
    ctx.fillText("Bereit. Bitte DNA eingeben.", 50, 250);

    // --- LOGIK ---
    dnaInput.addEventListener('input', (e) => {
        let raw = e.target.value.toUpperCase().replace(/[^ACGT]/g, '');
        let fmt = raw.replace(/(.{3})/g, '$1 ').trim();
        if(dnaInput.value !== fmt) dnaInput.value = fmt;
        
        processDNA(raw);
    });

    function processDNA(raw) {
        const triplets = raw.match(/.{1,3}/g) || [];
        let seq = [];
        let seq3 = [];
        let error = "";

        for(let t of triplets) {
            if(t.length < 3) continue;
            let aa = codonTable[t];
            if(!aa) { error = "Unbekannt: " + t; continue; }
            if(aa === 'STOP') break;
            seq.push(aa);
            seq3.push(aaData[aa].n);
        }

        document.getElementById('errorMsg').innerText = error;
        document.getElementById('out3').innerText = seq3.join('-');
        document.getElementById('out1').innerText = seq.join('');
        
        if(seq.length > 0) {
            let smiles = buildSmiles(seq);
            document.getElementById('outSmiles').innerText = smiles;
            draw(smiles, seq.length);
        } else {
            document.getElementById('outSmiles').innerText = "-";
        }
    }

    function buildSmiles(seq) {
        let s = "";
        seq.forEach(aa => {
            if(aa === 'P') s += "N1[C@@H](CCC1)C(=O)";
            else if(aa === 'G') s += "NCC(=O)"; // Glycin
            else s += `N[C@@H](${aaData[aa].s})C(=O)`;
        });
        return s + "O";
    }

    function draw(smiles, count) {
        if(typeof SmilesDrawer === 'undefined') {
            alert("Fehler: Zeichenbibliothek nicht geladen.");
            return;
        }

        // 1. Sichere Dimensionen berechnen
        // Wir gehen weg von den riesigen 2000px, die das Zentrieren kaputt machen.
        // Stattdessen passen wir die HÃ¶he moderat an.
        
        let w = Math.max(800, count * 60); // Breite wÃ¤chst mit
        let h = 600; // Feste, sichere HÃ¶he

        chemCanvas.width = w;
        chemCanvas.height = h;

        let options = {
            width: w,
            height: h,
            bondThickness: 1.0,
            bondLength: 18,     // Standard-LÃ¤nge, sicher
            shortBondLength: 0.85,
            fontSize: 10,
            padding: 20,        // Wenig Padding
            experimentalSSSR: true,
            debug: false
        };

        drawer = new SmilesDrawer.Drawer(options);
        
        SmilesDrawer.parse(smiles, function(tree) {
            drawer.draw(tree, 'chemCanvas', 'light', false);
        }, function(err) {
            console.log(err);
        });
    }

    // --- TEST FUNKTION ---
    window.drawTestMolecule = function() {
        // Zeichnet Koffein als Test
        let caffeine = "CN1C=NC2=C1C(=O)N(C(=O)N2C)C";
        document.getElementById('outSmiles').innerText = "Test: Koffein";
        draw(caffeine, 5);
    };

    // --- HELPERS ---
    window.copyToClip = (id) => {
        let txt = document.getElementById(id).innerText;
        if(txt && txt !== '-') navigator.clipboard.writeText(txt).then(()=>alert("Kopiert!"));
    };
    
    window.copyImg = () => {
        chemCanvas.toBlob(b => {
            try { 
                navigator.clipboard.write([new ClipboardItem({"image/png":b})]); 
                alert("Bild kopiert!"); 
            } catch(e) { alert("Browser-Sicherheit blockiert Bild-Kopie."); }
        });
    };

</script>
</body>
</html>
